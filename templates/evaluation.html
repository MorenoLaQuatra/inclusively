{% include "header.html" %}

{% block content %}
    <!-- H1 centered Inclusively -->
    <h1 style="text-align: center;">Evaluate Inclusively models</h1>

    <br>
    <hr>
    <br>

    <!-- divide page in two columns -->
    <div class="row">
        <div class="col-md-6">
            <!-- Textbox to enter text + button to submit -->
            <form action="/testing" method="post">
                <div class="mb-3">
                    <label for="input_text" class="form-label">Input</label>
                    <textarea class="form-control" id="input_text" name="input_text" rows="3"></textarea>
                </div>
                <!-- Submit button with onclick event - call function submit_text() -->
                <button type="button" class="btn btn-primary" onclick="submit_text()">Submit</button>
            </form>
            
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="output_text" class="form-label">Output</label>
                <div id="output_text">
                    <p>No text submitted yet.</p>
                </div>
            </div>
        </div>
            
    </div>

    <script>

        function submit_text() {
            // get the input text
            var input_text = document.getElementById("input_text").value;
            JsLoadingOverlay.show({
                'overlayBackgroundColor': '#444444',
                'overlayOpacity': 0.8,
                'spinnerIcon': 'ball-grid-pulse',
                'spinnerColor': '#ffffff',
                'spinnerSize': '2x',
                'overlayIDName': 'overlay',
                'spinnerIDName': 'spinner',
                'spinnerZIndex':99999,
                'overlayZIndex':99998
              });

            // send a POST request to the server
            // the server will return the output text
            // the output text will be displayed in the output text box
            $.ajax({
                type: "POST",
                url: "/submit_evaluation",
                data: {input_text: input_text},
                success: function(data) {
                    // get the dictionary. 
                    // if "success" is false then write the error message to the output_text html element
                    if (data["success"] == false) {
                        document.getElementById("output_text").innerHTML = "<p style='color: red;'>No data returned from the server.</p>";
                    } else {
                        // if "success"
                        // "output" -> "original_sentences" contains a list of the original sentences
                        // "output" -> "rewriting" contains a list of the modified sentences
                        // "output" -> "classification" contains a list of the classification of each sentence

                        //create a form
                        var form = document.createElement("form");
                        form.setAttribute("method", "post");
                        form.setAttribute("action", "/submit_feedback_evaluation");

                        // for each element in the list of original sentences (use a for loop with index)
                        for (var i = 0; i < data["output"]["original_sentences"].length; i++) {
                            // create a div
                            original_sentence = data["output"]["original_sentences"][i];
                            rewriting = data["output"]["rewriting"][i];
                            classification = data["output"]["classification"][i];

                            var div = document.createElement("div");
                            div.setAttribute("class", "mb-3");
                            // paragraph with the original sentence
                            // add classification as a class to the paragraph
                            var p_original = document.createElement("p");
                            p_original.setAttribute("class", classification);
                            // add class "original" to the paragraph
                            p_original.innerHTML = original_sentence;
                            div.appendChild(p_original);
                            // if classification is "not_inclusive" then add rewriting
                            if (classification == "not_inclusive") {
                                var p_rewriting = document.createElement("p");
                                p_rewriting.setAttribute("class", "rewriting");
                                p_rewriting.innerHTML = rewriting;
                                div.appendChild(p_rewriting);
                            }

                            // add a checkbox to get the feedback for the classification
                            var input = document.createElement("input");
                            input.setAttribute("type", "checkbox");
                            input.setAttribute("name", "not_correct_classification_" + i);
                            input.setAttribute("value", "correct");
                            // label for the checkbox - Correct
                            var label = document.createElement("label");
                            label.setAttribute("for", "not_correct_classification_" + i);
                            label.innerHTML = "Classification is <b>not</b> correct";
                            div.appendChild(input);
                            div.appendChild(label);

                            // separate with a br
                            var br = document.createElement("br");
                            div.appendChild(br);
                            div.appendChild(br);

                            // add a checkbox to get the feedback for the rewriting
                            var input = document.createElement("input");
                            input.setAttribute("type", "checkbox");
                            input.setAttribute("name", "not_correct_rewriting" + i);
                            input.setAttribute("value", "true");
                            // label for the checkbox - Correct
                            var label = document.createElement("label");
                            label.setAttribute("for", "not_correct_rewriting" + i);
                            label.innerHTML = "Rewriting is <b>not</b> correct";
                            div.appendChild(input);
                            div.appendChild(label);

                            // separate with a br
                            var br = document.createElement("br");
                            div.appendChild(br);
                            div.appendChild(br);

                            // add a textarea input to insert possible rewriting
                            var textarea = document.createElement("textarea");
                            textarea.setAttribute("class", "form-control");
                            textarea.setAttribute("id", "rewriting_feedback_" + i);
                            textarea.setAttribute("name", "rewriting_feedback_" + i);
                            textarea.setAttribute("rows", "3");
                            textarea.setAttribute("placeholder", "Insert possible rewriting");
                            div.appendChild(textarea);

                            // separate with a br
                            var br = document.createElement("br");
                            div.appendChild(br);
                            div.appendChild(br);
                            
                            form.appendChild(div);




                            // append hr to the form
                            var hr = document.createElement("hr");
                            form.appendChild(hr);


                        }

                        //append a submit button to the form
                        var button = document.createElement("button");
                        button.setAttribute("type", "button");
                        button.setAttribute("class", "btn btn-success");
                        button.setAttribute("onclick", "submit_feedback()");
                        button.innerHTML = "Submit feedback";
                        form.appendChild(button);

                        // put the form in the output_text html element
                        document.getElementById("output_text").innerHTML = "";
                        document.getElementById("output_text").appendChild(form);

                    }

                    //
                    JsLoadingOverlay.hide();

                }
            });
        }

        // a function to resize text area (input_text) to fit the text
        // https://stackoverflow.com/questions/454202/creating-a-textarea-with-auto-resize
        function resize_textarea() {
            var textarea = document.getElementById("input_text");
            textarea.style.height = "";
            textarea.style.height = Math.min(textarea.scrollHeight, 450) + "px";
        }

        // call resize_textarea() when the text in the input_text box changes
        document.getElementById("input_text").addEventListener("input", resize_textarea);Ã¹

        function submit_feedback(){
            // function used to submit feedback
            // get the form
            var form = document.getElementById("output_text").getElementsByTagName("form")[0];
            // get all classification checkboxes - not_correct_classification_ + index
            var checkboxes = form.querySelectorAll("input[name^='not_correct_classification_']");
            // get all rewriting checkboxes - not_correct_rewriting_ + index
            var checkboxes_rewriting = form.querySelectorAll("input[name^='not_correct_rewriting_']");
            // get all textarea - rewriting_feedback_ + index
            var textareas = form.querySelectorAll("textarea[name^='rewriting_feedback_']");
            // get all original sentences - class = "original"
            var original_sentences = form.querySelectorAll("p[class='original']");
            // get all rewriting sentences - class = "rewriting"
            var rewrites = form.querySelectorAll("p[class='rewriting']");

            // create a dictionary with the following keys:
            // "original_sentences" -> list of original sentences
            // "rewriting" -> list of rewrites
            // "classification" -> list of classification
            // "rewriting_feedback" -> list of rewriting feedback
            var data = {
                "original_sentences": [],
                "rewriting": [],
                "classification": [],
                "rewriting_feedback": []
            };

            // for each checkbox in checkboxes
            for (var i = 0; i < checkboxes.length; i++) {
                // if the checkbox is checked
                if (checkboxes[i].checked) {
                    // add the original sentence to the list of original sentences
                    data["original_sentences"].push(original_sentences[i].innerHTML);
                    // add the rewriting to the list of rewrites
                    data["rewriting"].push(rewrites[i].innerHTML);
                    // add the classification to the list of classification
                    data["classification"].push("not_inclusive");
                    // add the rewriting feedback to the list of rewriting feedback
                    data["rewriting_feedback"].push(textareas[i].value);
                } else {
                    // if the checkbox is not checked
                    // add the original sentence to the list of original sentences
                    data["original_sentences"].push(original_sentences[i].innerHTML);
                    // add the rewriting to the list of rewrites
                    data["rewriting"].push(rewrites[i].innerHTML);
                    // add the classification to the list of classification
                    data["classification"].push("inclusive");
                    // add the rewriting feedback to the list of rewriting feedback
                    data["rewriting_feedback"].push("");
                }
            }

        }

    </script>

    
{% endblock %}
  
{% include "footer.html" %}